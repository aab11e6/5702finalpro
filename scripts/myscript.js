
let data = [{"incident_hour_of_the_day":"0-5","incident_state":"NC","fraud_reported":"N","Major":2,"Minor":12,"Total":3,"Trivial":1},{"incident_hour_of_the_day":"0-5","incident_state":"NC","fraud_reported":"Y","Major":8,"Minor":2,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"0-5","incident_state":"NY","fraud_reported":"N","Major":6,"Minor":23,"Total":12,"Trivial":10},{"incident_hour_of_the_day":"0-5","incident_state":"NY","fraud_reported":"Y","Major":7,"Minor":2,"Total":2,"Trivial":1},{"incident_hour_of_the_day":"0-5","incident_state":"OH","fraud_reported":"N","Major":0,"Minor":3,"Total":1,"Trivial":0},{"incident_hour_of_the_day":"0-5","incident_state":"OH","fraud_reported":"Y","Major":4,"Minor":0,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"0-5","incident_state":"PA","fraud_reported":"N","Major":1,"Minor":1,"Total":1,"Trivial":1},{"incident_hour_of_the_day":"0-5","incident_state":"PA","fraud_reported":"Y","Major":0,"Minor":1,"Total":1,"Trivial":1},{"incident_hour_of_the_day":"0-5","incident_state":"SC","fraud_reported":"N","Major":7,"Minor":14,"Total":11,"Trivial":5},{"incident_hour_of_the_day":"0-5","incident_state":"SC","fraud_reported":"Y","Major":10,"Minor":2,"Total":3,"Trivial":1},{"incident_hour_of_the_day":"0-5","incident_state":"VA","fraud_reported":"N","Major":3,"Minor":9,"Total":7,"Trivial":2},{"incident_hour_of_the_day":"0-5","incident_state":"VA","fraud_reported":"Y","Major":2,"Minor":3,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"0-5","incident_state":"WV","fraud_reported":"N","Major":6,"Minor":21,"Total":12,"Trivial":11},{"incident_hour_of_the_day":"0-5","incident_state":"WV","fraud_reported":"Y","Major":5,"Minor":1,"Total":2,"Trivial":1},{"incident_hour_of_the_day":"6-11","incident_state":"NC","fraud_reported":"N","Major":2,"Minor":9,"Total":2,"Trivial":5},{"incident_hour_of_the_day":"6-11","incident_state":"NC","fraud_reported":"Y","Major":3,"Minor":2,"Total":2,"Trivial":2},{"incident_hour_of_the_day":"6-11","incident_state":"NY","fraud_reported":"N","Major":4,"Minor":29,"Total":5,"Trivial":7},{"incident_hour_of_the_day":"6-11","incident_state":"NY","fraud_reported":"Y","Major":9,"Minor":2,"Total":1,"Trivial":0},{"incident_hour_of_the_day":"6-11","incident_state":"OH","fraud_reported":"N","Major":1,"Minor":0,"Total":0,"Trivial":1},{"incident_hour_of_the_day":"6-11","incident_state":"OH","fraud_reported":"Y","Major":1,"Minor":0,"Total":1,"Trivial":0},{"incident_hour_of_the_day":"6-11","incident_state":"PA","fraud_reported":"N","Major":2,"Minor":2,"Total":2,"Trivial":0},{"incident_hour_of_the_day":"6-11","incident_state":"PA","fraud_reported":"Y","Major":2,"Minor":1,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"6-11","incident_state":"SC","fraud_reported":"N","Major":4,"Minor":14,"Total":14,"Trivial":13},{"incident_hour_of_the_day":"6-11","incident_state":"SC","fraud_reported":"Y","Major":10,"Minor":3,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"6-11","incident_state":"VA","fraud_reported":"N","Major":3,"Minor":9,"Total":6,"Trivial":3},{"incident_hour_of_the_day":"6-11","incident_state":"VA","fraud_reported":"Y","Major":5,"Minor":2,"Total":1,"Trivial":0},{"incident_hour_of_the_day":"6-11","incident_state":"WV","fraud_reported":"N","Major":2,"Minor":17,"Total":14,"Trivial":10},{"incident_hour_of_the_day":"6-11","incident_state":"WV","fraud_reported":"Y","Major":8,"Minor":2,"Total":2,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"NC","fraud_reported":"N","Major":4,"Minor":4,"Total":6,"Trivial":1},{"incident_hour_of_the_day":"12-17","incident_state":"NC","fraud_reported":"Y","Major":5,"Minor":3,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"NY","fraud_reported":"N","Major":5,"Minor":23,"Total":23,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"NY","fraud_reported":"Y","Major":13,"Minor":2,"Total":3,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"OH","fraud_reported":"N","Major":0,"Minor":3,"Total":1,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"OH","fraud_reported":"Y","Major":2,"Minor":0,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"PA","fraud_reported":"N","Major":2,"Minor":4,"Total":3,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"PA","fraud_reported":"Y","Major":1,"Minor":0,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"SC","fraud_reported":"N","Major":8,"Minor":24,"Total":18,"Trivial":4},{"incident_hour_of_the_day":"12-17","incident_state":"SC","fraud_reported":"Y","Major":17,"Minor":5,"Total":6,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"VA","fraud_reported":"N","Major":5,"Minor":6,"Total":7,"Trivial":3},{"incident_hour_of_the_day":"12-17","incident_state":"VA","fraud_reported":"Y","Major":4,"Minor":0,"Total":2,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"WV","fraud_reported":"N","Major":9,"Minor":17,"Total":23,"Trivial":0},{"incident_hour_of_the_day":"12-17","incident_state":"WV","fraud_reported":"Y","Major":4,"Minor":0,"Total":1,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"NC","fraud_reported":"N","Major":6,"Minor":9,"Total":7,"Trivial":3},{"incident_hour_of_the_day":"18-23","incident_state":"NC","fraud_reported":"Y","Major":4,"Minor":2,"Total":1,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"NY","fraud_reported":"N","Major":8,"Minor":23,"Total":26,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"NY","fraud_reported":"Y","Major":13,"Minor":1,"Total":2,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"OH","fraud_reported":"N","Major":1,"Minor":0,"Total":2,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"OH","fraud_reported":"Y","Major":2,"Minor":0,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"PA","fraud_reported":"N","Major":0,"Minor":0,"Total":2,"Trivial":1},{"incident_hour_of_the_day":"18-23","incident_state":"PA","fraud_reported":"Y","Major":0,"Minor":1,"Total":0,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"SC","fraud_reported":"N","Major":7,"Minor":19,"Total":13,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"SC","fraud_reported":"Y","Major":15,"Minor":0,"Total":1,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"VA","fraud_reported":"N","Major":4,"Minor":9,"Total":8,"Trivial":1},{"incident_hour_of_the_day":"18-23","incident_state":"VA","fraud_reported":"Y","Major":3,"Minor":1,"Total":2,"Trivial":0},{"incident_hour_of_the_day":"18-23","incident_state":"WV","fraud_reported":"N","Major":7,"Minor":12,"Total":15,"Trivial":2},{"incident_hour_of_the_day":"18-23","incident_state":"WV","fraud_reported":"Y","Major":10,"Minor":0,"Total":3,"Trivial":0}]

var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 750 - margin.left - margin.right,
    height = 550 - margin.top - margin.bottom;

const svg = d3.select("div#plot").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);


const x = d3.scaleBand().rangeRound([0, width]).paddingInner(0.05).align(0.1),
      y = d3.scaleLinear().rangeRound([height, 0]),
      z = d3.scaleOrdinal().range(['#6b486b','#8a89a6','#98abc5','#ff8c00']);


function updateChart(selectedState, selectedFraud) {

    const filteredData = data.filter(d => d.incident_state === selectedState && d.fraud_reported === selectedFraud);


    const keys = [ 'Total','Major','Minor','Trivial']; // 根据您的数据调整
    const stackData = d3.stack().keys(keys)(filteredData);


    x.domain(filteredData.map(d => d.incident_hour_of_the_day));
    y.domain([0, d3.max(stackData, d => d3.max(d, d => d[1]))]).nice();
    z.domain(keys);


    g.selectAll("*").remove();


    g.append("g")
      .selectAll("g")
      .data(stackData)
      .enter().append("g")
        .attr("fill", d => z(d.key))
      .selectAll("rect")
      .data(d => d)
      .enter().append("rect")
        .attr("x", d => x(d.data.incident_hour_of_the_day))
        .attr("y", d => y(d[1]))
        .attr("height", d => y(d[0]) - y(d[1]))
        .attr("width", x.bandwidth());


    g.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));


    g.append("g")
        .call(d3.axisLeft(y));

    g.append("text")
      .attr("transform", `translate(${width / 2}, ${height + margin.top + 10})`)
      .attr("text-anchor", "middle")
      .text("Incident Hour of the Day");


    g.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left)
      .attr("x", 0 - (height / 2))
      .attr("dy", "1em")
      .attr("text-anchor", "middle")
      .text("Incidents Count");

    // 添加图例
    const legend = g.append("g")
      .attr("font-family", "sans-serif")
      .attr("font-size", 10)
      .attr("text-anchor", "end")
    .selectAll("g")
    .data(keys.slice().reverse())
    .enter().append("g")
      .attr("transform", (d, i) => `translate(-20,${i * 20})`);

    legend.append("rect")
      .attr("x", width - 19)
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", z);

    legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(d => d);
}

// 为单选按钮添加事件监听
d3.selectAll('input[name="stateline"]').on('change', function() {
  const state = d3.select(this).property("value");
  const fraud = d3.select('input[name="fraudline"]:checked').property("value");
  updateChart(state, fraud);
});

d3.selectAll('input[name="fraudline"]').on('change', function() {
  const fraud = d3.select(this).property("value");
  const state = d3.select('input[name="stateline"]:checked').property("value");
  updateChart(state, fraud);
});

// 初始化图表
const initState = d3.select('input[name="stateline"]:checked').property("value");
const initFraud = d3.select('input[name="fraudline"]:checked').property("value");
updateChart(initState, initFraud);


